<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bootstrap demo</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/charts.css/dist/charts.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="container-fluid">
      <h1>Blood Presure Record</h1>
      <br />
      <div class="mb-3">
        <label for="FormSistolik" class="form-label fw-bold">Sistolik</label>
        <input type="text" class="form-control" id="FormSistolik" />
      </div>
      <div class="mb-3">
        <label for="FormDiastolik" class="form-label fw-bold">Diastolik</label
        ><input type="text" class="form-control" id="FormDiastolik" />
      </div>

      <div class="d-grid gap-2">
        <button class="btn btn-primary" type="button" onclick="simpanData()">
          Save
        </button>
      </div>
      <br />

      <h2>Record</h2>
      <table class="table">
        <thead>
          <tr>
            <th scope="col">No</th>
            <th scope="col">Tanggal</th>
            <th scope="col">Sistolik</th>
            <th scope="col">Diastolik</th>
            <th scope="col">Waktu</th>
            <th scope="col">Status</th>
          </tr>
        </thead>
        <tbody id="data-table">
          <tr>
            <td colspan="6">Memuat Data....</td>
          </tr>
        </tbody>
      </table>

      <h2>Chart</h2>
      <canvas id="sistolikChart"></canvas>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      const url =
        "https://script.google.com/macros/s/AKfycbyeZfxph2H-AZkEwqSb24gsXPnsdKlM8b93hkoDOZ0AyUCzE260SBcChdXzPHMABIn5/exec";

      async function simpanData() {
        var Sistolik = document.getElementById("FormSistolik").value;
        var Diastolik = document.getElementById("FormDiastolik").value;

        try {
          const response = await fetch(url, {
            redirect: "follow",
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({ Sistolik: Sistolik, Diastolik: Diastolik }),
          });

          const result = await response.json();
          if (result.status === "success") {
            alert("Berhasil menyimpan data!"); // ✅ Alert berhasil
            location.reload(); // ✅ Refresh halaman
          } else {
            alert("Gagal menyimpan data!");
          }
        } catch (error) {
          console.error("Error menyimpan data:", error);
          alert("Terjadi kesalahan!");
        }
      }

      async function fetchData() {
        try {
          const response = await fetch(url, {
            redirect: "follow",
            method: "GET",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
          });
          const data = await response.json();
          const tableBody = document.getElementById("data-table");

          let labels = [];
          let valuesSistolik = [];
          let valuesDiastolik = [];
          tableBody.innerHTML = "";
          // Logika Status

          data.slice(1).forEach((row, index) => {
            const tanggal = new Date(row[0]).toLocaleDateString();
            const Sistolik = row[1];
            const Diastolik = row[2];
            const Waktu = new Date(row[3]).toLocaleTimeString();

            labels.push(tanggal);
            valuesSistolik.push(Sistolik);
            valuesDiastolik.push(Diastolik);
            let status = '<i class="bi bi-emoji-smile-fill text-success"></i>';
            let statusClass = "normal";
            if (Sistolik >= 130) {
              status = '<i class="bi bi-emoji-angry-fill text-succes"></i>';
              statusClass = "danger";
            } else if (Sistolik >= 120) {
              status = '<i class="bi bi-emoji-frown-fill text-succes"></i>';
            }
            let tr = document.createElement("tr");
            tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${tanggal}</td>
                        <td>${Sistolik}</td>
                        <td>${Diastolik}</td>
                        <td>${Waktu}</td>
                        <td class="${statusClass}">${status}</td> 
                        
                    `;
            tableBody.appendChild(tr);
          });
          createGraphic(labels, valuesSistolik, valuesDiastolik);
        } catch (error) {
          console.error("Gagal Mengambil data", error);
          document.getElementById("data-table").innerHTML =
            "<tr><td cols='4'>Gagal Memuat Data</td></tr>";
        }
      }

      function createGraphic(labels, valuesSistolik, valuesDiastolik) {
        const ctx = document.getElementById("sistolikChart").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Tekanan Sistolik",
                data: valuesSistolik,
                borderColor: "blue",
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                borderWidth: 2,
                pointRadius: 5,
                pointBackgroundColor: "blue",
              },{
                label: "Tekanan Diastolik",
                data: valuesDiastolik,
                borderColor: "yellow",
                backgroundColor: "rgba(145, 250, 168, 0.2)",
                borderWidth: 2,
                pointRadius: 5,
                pointBackgroundColor: "yellow",
              }
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true },
            },
            scales: {
              y: { beginAtZero: false },
            },
          },
        });
      }

      fetchData();
    </script>
  </body>
</html>
